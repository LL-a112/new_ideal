<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>全球地图</title>
<link rel="stylesheet" href="css/style.css">
<script src="js/echarts.min.js"></script>
</head>
<body>
<header>
    <h1>全球咖啡消费地图</h1>
    <nav>
        <a href="index.html">首页</a>
        <a href="health.html">健康分析</a>
        <a href="map.html">全球地图</a>
        <a href="category.html">分类分析</a>
    </nav>
</header>

<div class="container">
    <div id="map-chart" class="chart-container" style="width:100%; height:900px;"></div>
</div>

<script>
let mapChart = echarts.init(document.getElementById('map-chart'));
mapChart.showLoading();

// 异步加载地图和数据
Promise.all([
    fetch('world.json').then(res => res.json()),
    fetch('data/coffee.json').then(res => res.json())
]).then(([worldJson, coffeeData]) => {
    mapChart.hideLoading();
    echarts.registerMap('worldMap', worldJson);

    // 计算每个国家平均咖啡摄入
    const countryMap = {};
    coffeeData.forEach(d => {
        if(!countryMap[d.Country]) countryMap[d.Country] = {sum:0,count:0};
        countryMap[d.Country].sum += d.Coffee_Intake;
        countryMap[d.Country].count += 1;
    });

    const dataList = Object.keys(countryMap).map(c=>{
        const avg = countryMap[c].sum / countryMap[c].count;
        return { name:c, value: parseFloat(avg.toFixed(2)) };
    });

    const values = dataList.map(d=>d.value);
    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);

    // 配置 option（借鉴美国例子结构）
    const option = {
        title: {
            text: '全球平均咖啡摄入量',
            left: 'center'
        },
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c} cups/day'
        },
        visualMap: {
            min: minVal,
            max: maxVal,
            left: 'right',
            top: 'bottom',
            text: ['High','Low'],
            calculable: true,
            inRange: {
                color: ['#B0E0E6','#FF5722']
            }
        },
        toolbox: {
            show: true,
            left: 'left',
            top: 'top',
            feature: {
                dataView: {readOnly:false},
                restore: {},
                saveAsImage: {}
            }
        },
        series: [{
            name: 'Average Coffee Intake',
            type: 'map',
            map: 'worldMap',
            roam: false,
            label: { show: false },
            data: dataList,
            emphasis: { label: { show: true } }
        }]
    };

    mapChart.setOption(option);
}).catch(err=>{
    mapChart.hideLoading();
    console.error('加载地图或数据失败:', err);
});
</script>
</body>
</html>
